<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据双向绑定实现原理 | 前端笔记</title>
    <meta name="description" content="Welcome to my VuePress site">
    <link rel="icon" href="/assets/images/F_1.png">
    
    <link rel="preload" href="/assets/css/0.styles.92bf089a.css" as="style"><link rel="preload" href="/assets/js/app.b2c9b148.js" as="script"><link rel="preload" href="/assets/js/2.abe796d4.js" as="script"><link rel="preload" href="/assets/js/50.1707f014.js" as="script"><link rel="prefetch" href="/assets/js/10.9dabb9bd.js"><link rel="prefetch" href="/assets/js/11.04035704.js"><link rel="prefetch" href="/assets/js/12.d1c01deb.js"><link rel="prefetch" href="/assets/js/13.ed96e02d.js"><link rel="prefetch" href="/assets/js/14.d32119f6.js"><link rel="prefetch" href="/assets/js/15.b13a1f1f.js"><link rel="prefetch" href="/assets/js/16.bcfbc81c.js"><link rel="prefetch" href="/assets/js/17.3d0adf24.js"><link rel="prefetch" href="/assets/js/18.53775fa0.js"><link rel="prefetch" href="/assets/js/19.b9763f17.js"><link rel="prefetch" href="/assets/js/20.5a1c82f0.js"><link rel="prefetch" href="/assets/js/21.d73d9897.js"><link rel="prefetch" href="/assets/js/22.d4e79057.js"><link rel="prefetch" href="/assets/js/23.3543db86.js"><link rel="prefetch" href="/assets/js/24.3f2eb633.js"><link rel="prefetch" href="/assets/js/25.9972ea34.js"><link rel="prefetch" href="/assets/js/26.d0eca9ed.js"><link rel="prefetch" href="/assets/js/27.45e32bd3.js"><link rel="prefetch" href="/assets/js/28.915e2ce3.js"><link rel="prefetch" href="/assets/js/29.a284cff2.js"><link rel="prefetch" href="/assets/js/3.a1169938.js"><link rel="prefetch" href="/assets/js/30.10f563a6.js"><link rel="prefetch" href="/assets/js/31.42548ff5.js"><link rel="prefetch" href="/assets/js/32.8791afc7.js"><link rel="prefetch" href="/assets/js/33.8fcfc8a9.js"><link rel="prefetch" href="/assets/js/34.1f850750.js"><link rel="prefetch" href="/assets/js/35.d26159f8.js"><link rel="prefetch" href="/assets/js/36.281468e2.js"><link rel="prefetch" href="/assets/js/37.1b89c5ed.js"><link rel="prefetch" href="/assets/js/38.489c6634.js"><link rel="prefetch" href="/assets/js/39.8efc661d.js"><link rel="prefetch" href="/assets/js/4.59d9b613.js"><link rel="prefetch" href="/assets/js/40.5e872685.js"><link rel="prefetch" href="/assets/js/41.443bceec.js"><link rel="prefetch" href="/assets/js/42.8856a770.js"><link rel="prefetch" href="/assets/js/43.524ebbbf.js"><link rel="prefetch" href="/assets/js/44.185defdf.js"><link rel="prefetch" href="/assets/js/45.48e08d59.js"><link rel="prefetch" href="/assets/js/46.d9e94c92.js"><link rel="prefetch" href="/assets/js/47.897e749a.js"><link rel="prefetch" href="/assets/js/48.0cb5d701.js"><link rel="prefetch" href="/assets/js/49.f6290809.js"><link rel="prefetch" href="/assets/js/5.f573f0ae.js"><link rel="prefetch" href="/assets/js/51.b8ecac9a.js"><link rel="prefetch" href="/assets/js/52.84c4fc59.js"><link rel="prefetch" href="/assets/js/6.0c2501b3.js"><link rel="prefetch" href="/assets/js/7.b9517656.js"><link rel="prefetch" href="/assets/js/8.d39559a9.js"><link rel="prefetch" href="/assets/js/9.c4986c38.js">
    <link rel="stylesheet" href="/assets/css/0.styles.92bf089a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/images/F_1.png" alt="前端笔记" class="logo"> <span class="site-name can-hide">前端笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/home/base.html" class="nav-link">指南</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/PE/nginx.html" class="nav-link">PE</a></li><li class="dropdown-item"><!----> <a href="/vue/dataBinding.html" class="nav-link router-link-exact-active router-link-active">vue</a></li><li class="dropdown-item"><!----> <a href="/flutter/base.html" class="nav-link">flutter</a></li><li class="dropdown-item"><!----> <a href="/node/koa2.html" class="nav-link">node</a></li><li class="dropdown-item"><!----> <a href="/rules/eslint.html" class="nav-link">代码规范</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="国际化" class="dropdown-title"><span class="title">国际化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">国际化?不存在的😂</a></li></ul></div></div><div class="nav-item"><a href="/leaveMessage/base.html" class="nav-link">留言</a></div> <a href="https://github.com/duanxiongfei-2016/notes.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/home/base.html" class="nav-link">指南</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/PE/nginx.html" class="nav-link">PE</a></li><li class="dropdown-item"><!----> <a href="/vue/dataBinding.html" class="nav-link router-link-exact-active router-link-active">vue</a></li><li class="dropdown-item"><!----> <a href="/flutter/base.html" class="nav-link">flutter</a></li><li class="dropdown-item"><!----> <a href="/node/koa2.html" class="nav-link">node</a></li><li class="dropdown-item"><!----> <a href="/rules/eslint.html" class="nav-link">代码规范</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="国际化" class="dropdown-title"><span class="title">国际化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">国际化?不存在的😂</a></li></ul></div></div><div class="nav-item"><a href="/leaveMessage/base.html" class="nav-link">留言</a></div> <a href="https://github.com/duanxiongfei-2016/notes.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/vue/dataBinding.html" class="active sidebar-link">数据双向绑定实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue/dataBinding.html#object-defineproperty" class="sidebar-link">Object.defineProperty()</a></li><li class="sidebar-sub-header"><a href="/vue/dataBinding.html#dep订阅器" class="sidebar-link">Dep订阅器</a></li><li class="sidebar-sub-header"><a href="/vue/dataBinding.html#watcher订阅者" class="sidebar-link">Watcher订阅者</a></li></ul></li><li><a href="/vue/v-model.html" class="sidebar-link">自定义组件v-model</a></li><li><a href="/vue/componentCommunication.html" class="sidebar-link">组件之间通信</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数据双向绑定实现原理"><a href="#数据双向绑定实现原理" aria-hidden="true" class="header-anchor">#</a> 数据双向绑定实现原理</h1> <h2 id="object-defineproperty"><a href="#object-defineproperty" aria-hidden="true" class="header-anchor">#</a> Object.defineProperty()</h2> <p>实现mvvm的双向绑定，是采用数据劫持结合发布者-订阅者模式的方式，通过Object.defineProperty()来劫持各个属性的setter，getter，在数据变动时发布消息给订阅者，触发相应的监听回调。就必须要实现以下几点：</p> <blockquote><ul><li>实现一个数据监听器Observer，能够对数据对象的所有属性进行监听，如有变动可拿到最新值并通知订阅者</li> <li>实现一个指令解析器Compile，对每个元素节点的指令进行扫描和解析，根据指令模板替换数据，以及绑定相应的更新函数</li> <li>实现一个Watcher，作为连接Observer和Compile的桥梁，能够订阅并收到每个属性变动的通知，执行指令绑定的相应回调函数，从而更新视图</li></ul></blockquote> <p><img src="https://upload-images.jianshu.io/upload_images/8560482-d18d5fe20c1ade5c.png" alt="yy"></p> <p>数据的每次读和写能够被我们看的见，即我们能够知道数据什么时候被读取了或数据什么时候被改写了，我们将其称为数据变的‘可观测’。</p> <p>要将数据变的‘可观测’，我们就要借助前面提到的<code>Object.defineProperty</code>方法了</p> <ol><li>首先，我们定义一个数据对象car</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> car <span class="token operator">=</span> <span class="token punctuation">{</span>
    brand<span class="token string">': '</span>宝马'<span class="token punctuation">,</span>
    price'<span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们定义了这个<code>car</code>。现在我们可以通过<code>car.brand</code>和<code>car.price</code>直接读写这个<code>car</code>对应的属性值。但是，当这个<code>car</code>的属性被读取或修改时，我们并不知情。那么应该如何做才能够让<code>car</code>主动告诉我们，它的属性被修改了呢？</p> <ol start="2"><li>接下来，我们使用<code>Object.defineProperty()</code>改写上面的例子</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> car <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token number">3000</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>car<span class="token punctuation">,</span> <span class="token string">'price'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//  表示能否通过delete将属性删除，能否把属性修改为数据属性</span>
    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 表示属性可否被枚举(即是否可以通过for in循环返回)</span>
    <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'price属性被读取了'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'price属性被修改了'</span><span class="token punctuation">)</span>
       val <span class="token operator">=</span> newVal
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>通过<code>Object.defineProperty()</code>方法给<code>car</code>定义了一个<code>price</code>属性，并把这个属性的读和写分别使用<code>get()</code>和<code>set()</code>进行拦截，每当该属性进行读或写操作的时候就会触发<code>get()</code>和<code>set()</code>,操作结果如下</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>&gt; car<span class="token punctuation">.</span>price
    price属性被读取了        VM10874:5
    3000
&gt; car<span class="token punctuation">.</span>price = 5000
    price属性被修改了        VM10874:9
    5000
</code></pre></div><p>可以看到，<code>car</code>已经可以主动告诉我们它的属性的读写情况了，这也意味着，这个<code>car</code>的数据对象已经是“可观测”的了。</p> <ol start="3"><li>为了把<code>car</code>的所有属性都变得可观测，我们可以编写如下两个函数：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 把一个对象的每一项都转化成可观测对象
 * @param { Object } obj 对象
 */</span>
<span class="token keyword">function</span> <span class="token function">observable</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj <span class="token operator">||</span> <span class="token keyword">typeof</span> obj <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> obj
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 使一个对象转化成可观测对象
 * @param { Object } obj 对象
 * @param { String } key 对象的key
 * @param { Any } val 对象的某个key的值
 */</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">属性被读取了</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span> <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">属性被修改了</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            val <span class="token operator">=</span> newVal
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在，我们就可以这样定义<code>car</code>, <code>car</code>的两个属性都变得可观测了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> car <span class="token operator">=</span> <span class="token function">observable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    brand<span class="token punctuation">:</span> <span class="token string">'BMW'</span><span class="token punctuation">,</span>
    price<span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="dep订阅器"><a href="#dep订阅器" aria-hidden="true" class="header-anchor">#</a> Dep订阅器</h2> <blockquote><p>完成了数据的'可观测'，即我们知道了数据在什么时候被读或写了，那么，我们就可以在数据被读或写的时候通知那些依赖该数据的视图更新了，为了方便，我们需要先将所有依赖收集起来，一旦数据发生变化，就统一通知更新。其实，这就是典型的“发布订阅者”模式，数据变化为“发布者”，依赖对象为“订阅者”。</p></blockquote> <p>现在，我们需要创建一个依赖收集容器，也就是消息订阅器Dep，用来容纳所有的“订阅者”。订阅器Dep主要负责收集订阅者，然后当数据变化的时候后执行对应订阅者的更新函数。</p> <ol><li>创建消息订阅器<code>Dep</code></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//增加订阅者</span>
    <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//判断是否增加订阅者</span>
    <span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//通知订阅者更新</span>
    <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">sub</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
</code></pre></div><ol start="2"><li>有了订阅器<code>Dep</code>，再将<code>defineReactive</code>函数进行改造一下，向其植入订阅器</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">属性被读取了</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span> <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            val <span class="token operator">=</span> newVal
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">属性被修改了</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">// 数据变化通知所有订阅者</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>到此，订阅器<code>Dep</code>设计完毕，接下来，我们设计订阅者<code>Watcher</code></li></ol> <h2 id="watcher订阅者"><a href="#watcher订阅者" aria-hidden="true" class="header-anchor">#</a> Watcher订阅者</h2> <blockquote><p>订阅者<code>Watcher</code>在初始化的时候需要将自己添加进订阅器<code>Dep</code>中，那该如何添加呢？我们已经知道监听器<code>Observer</code>是在<code>get</code>函数执行了添加订阅者<code>Wather</code>的操作的，所以我们只要在订阅者<code>Watcher</code>初始化的时候出发对应的<code>get</code>函数去执行添加订阅者操作即可，那要如何触发<code>get</code>的函数，再简单不过了，只要获取对应的属性值就可以触发了，核心原因就是因为我们使用了<code>Object.defineProperty()</code>进行数据监听。这里还有一个细节点需要处理，我们只要在订阅者<code>Watcher</code>初始化的时候才需要添加订阅者，所以需要做一个判断操作，因此可以在订阅器上做一下手脚：在<code>Dep.target</code>上缓存下订阅者，添加成功后再将其去掉就可以了。</p></blockquote> <p>订阅者<code>Watcher</code>的实现如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
        <span class="token keyword">this</span><span class="token punctuation">.</span>exp <span class="token operator">=</span> exp
        <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 将自己添加到订阅器的操作</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>exp<span class="token punctuation">]</span>
        <span class="token keyword">let</span> oldVal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>  <span class="token comment">// 缓存自己</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>exp<span class="token punctuation">]</span>  <span class="token comment">// 强制执行监听器里的get函数</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>  <span class="token comment">// 释放自己</span>
        <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// vm: 一个Vue的实例对象</span>
<span class="token comment">// exp: 是node节点的v-model或v-on：click等指令的属性值。如v-model=&quot;name&quot;，exp就是name</span>
<span class="token comment">// cb: 是Watcher绑定的更新函数</span>
</code></pre></div> <!----></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/duanxiongfei-2016/notes.git/edit/master/vue/dataBinding.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">35 分钟前</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/vue/v-model.html">自定义组件v-model</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;right:65px;bottom:0px;width:135px;height:300px;z-index:99999;opacity:0.8;pointer-events:none;"><canvas id="live2dcanvas" width="135" height="300" class="live2dcanvas" style="position:absolute;left:0px;top:0px;width:135px;height:300px;"></canvas></div></div></div>
    <script src="/assets/js/app.b2c9b148.js" defer></script><script src="/assets/js/2.abe796d4.js" defer></script><script src="/assets/js/50.1707f014.js" defer></script>
  </body>
</html>
